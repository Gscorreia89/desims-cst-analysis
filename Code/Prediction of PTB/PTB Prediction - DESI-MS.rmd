---
title: "Preterm birth prediction using the DESI-MS profiles" 
output: html_notebook
---

```{r "setup", include=FALSE}
require("knitr")
opts_knit$set(root.dir='./')
```

Load the required packages
```{r, include=FALSE}
library(ggplot2)
library(doParallel)
library(readr)
library(caret)
library(plotROC)
library(pROC)
library(dplyr)
set.seed(124825)
# Set ggplot titles to appear at center
ggplot() + theme(plot.title = element_text(hjust = 'center'))
registerDoParallel(cores=22)
dir.create('./PTB_Prediction/', recursive=TRUE)
```


# Data import
### Load the VMET2 DESI-MS Positive and Negative mode datasets 
```{r, warning=F, echo=F, message=F}
# Load the datasets
desi_neg_vmet2 <- read.table("../../Data/VMET2_DESI-MS_NEG.csv", header=1, sep=',')
desi_pos_vmet2 <- read.table("../../Data/VMET2_DESI-MS_POS.csv", header=1, sep=',')

# Load the Study Metadata
study_metadata_vmet2 <- read_csv("../../Data/VMET2_Metadata.csv")
cst_metadata_vmet2 <- read_csv("../../Data/VMET2_CSTAssignment.csv")

study_metadata_vmet2 <- merge(study_metadata_vmet2, cst_metadata_vmet2, by='Seq_ID')

# Merge with the clinical metadata
desi_pos_vmet2 <- merge(study_metadata_vmet2, desi_pos_vmet2, by.x="DESI_ID", by.y="DESI_ID", sort=FALSE)
desi_neg_vmet2 <- merge(study_metadata_vmet2, desi_neg_vmet2, by.x="DESI_ID", by.y="DESI_ID", sort=FALSE)
colnames(desi_pos_vmet2)[colnames(desi_pos_vmet2) == 'Seq_ID.x'] <- 'Seq_ID'
colnames(desi_neg_vmet2)[colnames(desi_neg_vmet2) == 'Seq_ID.x'] <- 'Seq_ID'

# Load the data QC results and exclude samples with low spectral quality
desi_neg_vmet2_QC <- read.table("../CST Typing by DESI-MS/DESI-MS QC/VMET2_DESI_Negative_QC.csv", header=1, sep=',')
desi_pos_vmet2_QC <- read.table("../CST Typing by DESI-MS/DESI-MS QC/VMET2_DESI_Positive_QC.csv", header=1, sep=',')

# Exclude the samples flagged in the DESI-MS Data QC Notebook
neg_vmet2_exclusions <- desi_neg_vmet2_QC[desi_neg_vmet2_QC$Exclude == TRUE, 'DESI_ID']
pos_vmet2_exclusions <- desi_neg_vmet2_QC[desi_pos_vmet2_QC$Exclude == TRUE, 'DESI_ID']
desi_neg_vmet2 <- desi_neg_vmet2[!(desi_neg_vmet2$DESI_ID %in% neg_vmet2_exclusions), ]
desi_pos_vmet2 <- desi_pos_vmet2[!(desi_pos_vmet2$DESI_ID %in% pos_vmet2_exclusions), ]

# remove intermediate variables
rm(study_metadata_vmet2)
rm(cst_metadata_vmet2)
rm(desi_neg_vmet2_QC)
rm(desi_pos_vmet2_QC)
rm(neg_vmet2_exclusions)
rm(pos_vmet2_exclusions)
```

### Load the VMET DESI-MS Positive and Negative mode datasets
```{r, warning=F, echo=F, message=F}
# Load the DESI-MS datasets
desi_neg_vmet <- read.table("../../Data/VMET_DESI-MS_NEG.csv", header=1, sep=',')
desi_pos_vmet <- read.table("../../Data/VMET_DESI-MS_POS.csv", header=1, sep=',')

# Load the Study Metadata
study_metadata_vmet <- read_csv("../../Data/VMET_Metadata.csv")
cst_metadata_vmet <- read_csv("../../Data/VMET_CSTAssignment.csv")

study_metadata_vmet <- merge(study_metadata_vmet, cst_metadata_vmet, by='Seq_ID')

# Merge with the clinical metadata
desi_pos_vmet <- merge(study_metadata_vmet, desi_pos_vmet, by.x="DESI_ID", by.y="DESI_ID", sort=FALSE)
desi_neg_vmet <- merge(study_metadata_vmet, desi_neg_vmet, by.x="DESI_ID", by.y="DESI_ID", sort=FALSE)
colnames(desi_pos_vmet)[colnames(desi_pos_vmet) == 'Seq_ID.x'] <- 'Seq_ID'
colnames(desi_neg_vmet)[colnames(desi_neg_vmet) == 'Seq_ID.x'] <- 'Seq_ID'

# Load the data QC results and exclude samples with low spectral quality
desi_neg_vmet_QC <- read.table("../CST Typing by DESI-MS/DESI-MS QC/VMET_DESI_Negative_QC.csv", header=1, sep=',')
desi_pos_vmet_QC <- read.table("../CST Typing by DESI-MS/DESI-MS QC/VMET_DESI_Positive_QC.csv", header=1, sep=',')

# Exclude the samples flagged in the DESI-MS Data QC Notebook
neg_vmet_exclusions <- desi_neg_vmet_QC[desi_neg_vmet_QC$Exclude == TRUE, 'DESI_ID']
pos_vmet_exclusions <- desi_pos_vmet_QC[desi_pos_vmet_QC$Exclude == TRUE, 'DESI_ID']
desi_neg_vmet <- desi_neg_vmet[!(desi_neg_vmet$DESI_ID %in% neg_vmet_exclusions), ]
desi_pos_vmet <- desi_pos_vmet[!(desi_pos_vmet$DESI_ID %in% pos_vmet_exclusions), ]

# remove intermediate variables
rm(study_metadata_vmet)
rm(cst_metadata_vmet)
rm(desi_neg_vmet_QC)
rm(desi_pos_vmet_QC)
rm(neg_vmet_exclusions)
rm(pos_vmet_exclusions)
```
### Quick overview of dataset dimensions and indexes
```{r}
# VMET2 DESI-MS Negative Mode
# Assign a variable with the index of the first column corresponding to an MS signal, helpful to select only metabolic variables in each dataset in subsequent analyses.
desineg_first_metabolite_idx_vmet2 <- 29
cat(paste("VMET2 DESI-MS Negative Mode Matrix: ", dim(desi_neg_vmet2)[1], "samples, ", dim(desi_neg_vmet2)[2] - 29, "metabolic features", "\n"))

# VMET2 DESI-MS Positive Mode
desipos_first_metabolite_idx_vmet2 <- 29
cat(paste("VMET2 DESI-MS Positive Mode Matrix: ", dim(desi_pos_vmet2)[1], "samples, ", dim(desi_pos_vmet2)[2] - 29, "metabolic features", "\n"))
# Assign a variable with the index of the first column corresponding to an MS signal

# VMET DESI-MS Negative Mode
desineg_first_metabolite_idx_vmet <- 28
cat(paste("VMET DESI-MS Negative Mode Matrix: ", dim(desi_neg_vmet)[1], "samples, ", dim(desi_neg_vmet)[2] - 28, "metabolic features", "\n"))
# Assign a variable with the index of the first column corresponding to an MS signal

# VMET DESI-MS Positive Mode
desipos_first_metabolite_idx_vmet <- 28
cat(paste("VMET DESI-MS Positive Mode Matrix: ", dim(desi_pos_vmet)[1], "samples, ", dim(desi_pos_vmet)[2] - 28, "metabolic features", "\n"))
# Assign a variable with the index of the first column corresponding to an MS signal
```
# Prediction of Preterm birth using the 16s microbiome profile.
In this analysis we examine if the 16S profiles can be directly used to predict preterm birth. A helper function, *random_forest_comparison_Outcome*, is defined in the next cell to handle the model fitting and cross-validation. The interface from the *caret* package is used to fit the random forest models and perform a repeated (n=15 times) 7-fold stratified cross validation. This function will then be applied to predict preterm birth using the centered-log-ratio transformed 16S data matrices. 
```{r}
# Prediction of preterm 
random_forest_comparison_Outcome <- function(dataset, first_variable_idx, outcome_var='Outcome') {
   dataset_train <- dataset[, colnames(dataset)[first_variable_idx:dim(dataset)[2]]]
   dataset_train <- cbind(Outcome=dataset[outcome_var], dataset_train)
   
   dataset_train$Outcome <- factor(dataset_train$Outcome)
   
   fit_control <- trainControl(method = "repeatedcv", repeats=15, classProbs = TRUE,
                              number = 7, summaryFunction=multiClassSummary, 
                              preProcOptions = c('center', 'scale'), savePredictions=TRUE)
    # mtry set to fix rule of thumb value 1/3 of nfeatures
   rf_fit <- train(Outcome ~ ., 
                   data = dataset_train, method='rf', trControl=fit_control, ntree=1000, metric='AUC', tuneGrid=data.frame(mtry=dim(dataset_train)[2]/3))
   
  return (rf_fit)
}

# Helper function to calculate parameters for roc curves and generate quick plots for inspection
get_roc <- function(model, levels, target) {
  
    #cv_original_class <- model$trainingData$.outcome
    cv_original_class <- model$pred$obs
    #cv_predictor_avg <- aggregate(as.formula(paste(target, "~ rowIndex")),model$pred,mean)[,target]
    cv_predictor_avg <- model$pred[, target]
    roc_test_set <- roc(cv_original_class, cv_predictor_avg, ci=TRUE)
    roc_data <- data.frame(Class=cv_original_class,target=cv_predictor_avg)
    roc_plot <- ggplot(roc_data, 
    aes(m = target, d = factor(Class, levels = c(levels)), color='firebrick')) + guides(color = FALSE) + 
    geom_roc(hjust = 0, vjust = 0) + coord_equal() + style_roc(theme=theme_grey, xlab='1 - Specificity', ylab='Sensitivity') +  annotate("label", x = .75, y = .25, 
           label = paste("Mean AUC =", round(roc_test_set$auc, 2)), color='firebrick')
    
    return(list(data=roc_data, roc=roc_test_set, plot=roc_plot)) 
}

# Utility function to select only a single sample per patient from a given trimester.
# This function will select a single sample per pateint, with a gestational age value closest sample to the target. Selected 
# samples are further filtered to ensure they do not deviate by max_week_difference.
getNearestSample <- function(dataset, gestational_age_target=12, gestational_age_var='GestationalAge', max_week_difference=6) {
   subsetDataset <- dataset %>%
   group_by(SubjectID) %>%
   slice(which.min(abs(get(gestational_age_var) - gestational_age_target))) %>%
    slice(which(abs(get(gestational_age_var) - gestational_age_target) <= max_week_difference))
   
return(subsetDataset)
}
```

## PTB prediction using samples from 1st, 2nd and 3rd trimester only - VMET2 dataset
```{r}
## VMET 
# 1st Trimester
vmet2_neg_1Trim <- getNearestSample(desi_neg_vmet2, 7, max_week_difference = 7)
ptb_vmet2_neg_1Trim <- random_forest_comparison_Outcome(subset(vmet2_neg_1Trim, Outcome %in% c("Term", "Preterm")), first_variable_idx = desineg_first_metabolite_idx_vmet2, outcome_var = 'Outcome')
rm(vmet2_neg_1Trim)

# 2nd Trimester
vmet2_neg_2Trim <- getNearestSample(desi_neg_vmet2, 19, max_week_difference = 5)
ptb_vmet2_neg_2Trim <- random_forest_comparison_Outcome(subset(vmet2_neg_2Trim, Outcome %in% c("Term", "Preterm")), first_variable_idx = desineg_first_metabolite_idx_vmet2, outcome_var = 'Outcome')
rm(vmet2_neg_2Trim)

# 3rd Trimester
vmet2_neg_3Trim <- getNearestSample(desi_neg_vmet2, 32, max_week_difference = 8)
ptb_vmet2_neg_3Trim <- random_forest_comparison_Outcome(subset(vmet2_neg_3Trim, Outcome %in% c("Term", "Preterm")), first_variable_idx = desineg_first_metabolite_idx_vmet2, outcome_var = 'Outcome')
rm(vmet2_neg_3Trim)
```
```{r}
## VMET 
# 1st Trimester
vmet2_pos_1Trim <- getNearestSample(desi_pos_vmet2, 7, max_week_difference = 7)
ptb_vmet2_pos_1Trim <- random_forest_comparison_Outcome(subset(vmet2_pos_1Trim, Outcome %in% c("Term", "Preterm")), first_variable_idx = desipos_first_metabolite_idx_vmet2, outcome_var = 'Outcome')
rm(vmet2_pos_1Trim)

# 2nd Trimester
vmet2_pos_2Trim <- getNearestSample(desi_pos_vmet2, 19, max_week_difference = 5)
ptb_vmet2_pos_2Trim <- random_forest_comparison_Outcome(subset(vmet2_pos_2Trim, Outcome %in% c("Term", "Preterm")), first_variable_idx = desipos_first_metabolite_idx_vmet2, outcome_var = 'Outcome')
rm(vmet2_pos_2Trim)

# 3rd Trimester
vmet2_pos_3Trim <- getNearestSample(desi_pos_vmet2, 32, max_week_difference = 8)
ptb_vmet2_pos_3Trim <- random_forest_comparison_Outcome(subset(vmet2_pos_3Trim, Outcome %in% c("Term", "Preterm")), first_variable_idx = desipos_first_metabolite_idx_vmet2, outcome_var = 'Outcome')
rm(vmet2_pos_3Trim)
```

Export result summary and ROC curves
```{r}
capture.output(print(ptb_vmet2_neg_1Trim), file='./PTB_Prediction/VMET2_DESI-Neg_1Trim_PTB.txt')
ROCPlot <- get_roc(ptb_vmet2_neg_1Trim, c('Term', 'Preterm'), 'Preterm')
ggsave(filename='./PTB_Prediction/VMET2_DESI-Neg_1Trim_PTB_ROC.png', ROCPlot$plot)
rm(ROCPlot)

capture.output(print(ptb_vmet2_neg_2Trim), file='./PTB_Prediction/VMET2_DESI-Neg_2Trim_PTB.txt')
ROCPlot <- get_roc(ptb_vmet2_neg_2Trim, c('Term', 'Preterm'), 'Preterm')
ggsave(filename='./PTB_Prediction/VMET2_DESI-Neg_2Trim_PTB_ROC.png', ROCPlot$plot)
rm(ROCPlot)

capture.output(print(ptb_vmet2_neg_3Trim), file='./PTB_Prediction/VMET2_DESI-Neg_3Trim_PTB.txt')
ROCPlot <- get_roc(ptb_vmet2_neg_3Trim, c('Term', 'Preterm'), 'Preterm')
ggsave(filename='./PTB_Prediction/VMET2_DESI-Neg_3Trim_PTB_ROC.png', ROCPlot$plot)
rm(ROCPlot)
```

```{r}
capture.output(print(ptb_vmet2_pos_1Trim), file='./PTB_Prediction/VMET2_DESI-Pos_1Trim_PTB.txt')
ROCPlot <- get_roc(ptb_vmet2_pos_1Trim, c('Term', 'Preterm'), 'Preterm')
ggsave(filename='./PTB_Prediction/VMET2_DESI-Pos_1Trim_PTB_ROC.png', ROCPlot$plot)
rm(ROCPlot)

capture.output(print(ptb_vmet2_pos_2Trim), file='./PTB_Prediction/VMET2_DESI-Pos_2Trim_PTB.txt')
ROCPlot <- get_roc(ptb_vmet2_pos_2Trim, c('Term', 'Preterm'), 'Preterm')
ggsave(filename='./PTB_Prediction/VMET2_DESI-Pos_2Trim_PTB_ROC.png', ROCPlot$plot)
rm(ROCPlot)

capture.output(print(ptb_vmet2_pos_3Trim), file='./PTB_Prediction/VMET_DESI-Pos_3Trim_PTB.txt')
ROCPlot <- get_roc(ptb_vmet2_pos_3Trim, c('Term', 'Preterm'), 'Preterm')
ggsave(filename='./PTB_Prediction/VMET2_DESI-Pos_3Trim_PTB_ROC.png', ROCPlot$plot)
rm(ROCPlot)
```

## PTB prediction using samples from 1st, 2nd and 3rd trimester only - VMET2 dataset
```{r}
## VMET 
# 1st Trimester
vmet_neg_1Trim <- getNearestSample(desi_neg_vmet, 7, max_week_difference = 7)
ptb_vmet_neg_1Trim <- random_forest_comparison_Outcome(subset(vmet_neg_1Trim, Outcome %in% c("Term", "Preterm")), first_variable_idx = desineg_first_metabolite_idx_vmet, outcome_var = 'Outcome')
rm(vmet_neg_1Trim)

# 2nd Trimester
vmet_neg_2Trim <- getNearestSample(desi_neg_vmet, 19, max_week_difference = 5)
ptb_vmet_neg_2Trim <- random_forest_comparison_Outcome(subset(vmet_neg_2Trim, Outcome %in% c("Term", "Preterm")), first_variable_idx = desineg_first_metabolite_idx_vmet, outcome_var = 'Outcome')
rm(vmet_neg_2Trim)

# 3rd Trimester
vmet_neg_3Trim <- getNearestSample(desi_neg_vmet2, 32, max_week_difference = 8)
ptb_vmet_neg_3Trim <- random_forest_comparison_Outcome(subset(vmet_neg_3Trim, Outcome %in% c("Term", "Preterm")), first_variable_idx = desineg_first_metabolite_idx_vmet, outcome_var = 'Outcome')
rm(vmet_neg_3Trim)
```

```{r}
## VMET 
# 1st Trimester
vmet_pos_1Trim <- getNearestSample(desi_pos_vmet, 7, max_week_difference = 7)
ptb_vmet_pos_1Trim <- random_forest_comparison_Outcome(subset(vmet_pos_1Trim, Outcome %in% c("Term", "Preterm")), first_variable_idx = desipos_first_metabolite_idx_vmet, outcome_var = 'Outcome')
rm(vmet_pos_1Trim)

# 2nd Trimester
vmet_pos_2Trim <- getNearestSample(desi_pos_vmet, 19, max_week_difference = 5)
ptb_vmet_pos_2Trim <- random_forest_comparison_Outcome(subset(vmet_pos_2Trim, Outcome %in% c("Term", "Preterm")), first_variable_idx = desipos_first_metabolite_idx_vmet, outcome_var = 'Outcome')
rm(vmet_pos_2Trim)

# 3rd Trimester
vmet_pos_3Trim <- getNearestSample(desi_pos_vmet, 32, max_week_difference = 8)
ptb_vmet_pos_3Trim <- random_forest_comparison_Outcome(subset(vmet_pos_3Trim, Outcome %in% c("Term", "Preterm")), first_variable_idx = desipos_first_metabolite_idx_vmet, outcome_var = 'Outcome')
rm(vmet_pos_3Trim)
```


Export result summary and ROC curves
```{r}
capture.output(print(ptb_vmet_neg_1Trim), file='./PTB_Prediction/VMET_DESI-Neg_1Trim_PTB.txt')
ROCPlot <- get_roc(ptb_vmet_neg_1Trim, c('Term', 'Preterm'), 'Preterm')
ggsave(filename='./PTB_Prediction/VMET_DESI-Neg_1Trim_PTB_ROC.png', ROCPlot$plot)
rm(ROCPlot)

capture.output(print(ptb_vmet_neg_2Trim), file='./PTB_Prediction/VMET_DESI-Neg_2Trim_PTB.txt')
ROCPlot <- get_roc(ptb_vmet_neg_2Trim, c('Term', 'Preterm'), 'Preterm')
ggsave(filename='./PTB_Prediction/VMET_DESI-Neg_2Trim_PTB_ROC.png', ROCPlot$plot)
rm(ROCPlot)

capture.output(print(ptb_vmet_neg_3Trim), file='./PTB_Prediction/VMET_DESI-Neg_3Trim_PTB.txt')
ROCPlot <- get_roc(ptb_vmet_neg_3Trim, c('Term', 'Preterm'), 'Preterm')
ggsave(filename='./PTB_Prediction/VMET_DESI-Neg_3Trim_PTB_ROC.png', ROCPlot$plot)
rm(ROCPlot)
```

```{r}
capture.output(print(ptb_vmet_pos_1Trim), file='./PTB_Prediction/VMET_DESI-Pos_1Trim_PTB.txt')
ROCPlot <- get_roc(ptb_vmet_pos_1Trim, c('Term', 'Preterm'), 'Preterm')
ggsave(filename='./PTB_Prediction/VMET_DESI-Pos_1Trim_PTB_ROC.png', ROCPlot$plot)
rm(ROCPlot)

capture.output(print(ptb_vmet_pos_2Trim), file='./PTB_Prediction/VMET_DESI-Pos_2Trim_PTB.txt')
ROCPlot <- get_roc(ptb_vmet_pos_2Trim, c('Term', 'Preterm'), 'Preterm')
ggsave(filename='./PTB_Prediction/VMET_DESI-Pos_2Trim_PTB_ROC.png', ROCPlot$plot)
rm(ROCPlot)

capture.output(print(ptb_vmet2_pos_3Trim), file='./PTB_Prediction/VMET_DESI-Pos_3Trim_PTB.txt')
ROCPlot <- get_roc(ptb_vmet2_pos_3Trim, c('Term', 'Preterm'), 'Preterm')
ggsave(filename='./PTB_Prediction/VMET_DESI-Pos_3Trim_PTB_ROC.png', ROCPlot$plot)
rm(ROCPlot)
```