---
title: "DESI-MS data quality assessment"
output: html_notebook
---

```{r "setup", include=FALSE}
require("knitr")
opts_knit$set(root.dir='./')
```

### Package import
```{r, include=FALSE}
library(ggplot2)
library(doParallel)
library(readr)
# Set ggplot titles to appear at center
ggplot() + theme(plot.title = element_text(hjust = 'center'))
registerDoParallel(cores=22)
dir.create('./DESI-MS QC/', recursive=TRUE)
```

# Data import
Load the VMET2 DESI-MS Positive and Negative mode datasets
```{r, warning=F, echo=F, message=F}
# Load the datasets
desi_neg_vmet2 <- read.table("../../Data/VMET2_DESI-MS_NEG.csv", header=1, sep=',')
desi_pos_vmet2 <- read.table("../../Data/VMET2_DESI-MS_POS.csv", header=1, sep=',')

study_metadata_vmet2 <- read_csv("../../Data/VMET2_Metadata.csv")

# Merge with the clinical metadata
desi_pos_vmet2 <- merge(study_metadata_vmet2, desi_pos_vmet2, by.x="DESI_ID", by.y="DESI_ID", sort=FALSE)
desi_neg_vmet2 <- merge(study_metadata_vmet2, desi_neg_vmet2, by.x="DESI_ID", by.y="DESI_ID", sort=FALSE)

rm(study_metadata_vmet2)
rm(EthnicityFactor)
rm(TimepointFactor)
rm(OutcomeFact)
rm(weeks_info)
rm(days_info)
```

Load the VMET DESI-MS Positive and Negative mode datasets
```{r, warning=F, echo=F, message=F}
# Load the datasets
desi_neg_vmet <- read.table("../../Data/VMET_DESI-MS_NEG.csv", header=1, sep=',')
desi_pos_vmet <- read.table("../../Data/VMET_DESI-MS_POS.csv", header=1, sep=',')

study_metadata_vmet <- read_csv("../../Data/VMET_Metadata.csv")

# Merge with the clinical metadata
desi_pos_vmet <- merge(study_metadata_vmet, desi_pos_vmet, by.x="DESI_ID", by.y="DESI_ID", sort=FALSE)
desi_neg_vmet <- merge(study_metadata_vmet, desi_neg_vmet, by.x="DESI_ID", by.y="DESI_ID", sort=FALSE)

rm(study_metadata_vmet)
rm(EthnicityFactor)
rm(TimepointFactor)
```

Overview of dataset dimensions
```{r}
# VMET2 DESI-MS Negative Mode
cat(paste("VMET2 DESI-MS Negative Mode Matrix: ", dim(desi_neg_vmet2)[1], "samples, ", dim(desi_neg_vmet2)[2] - 23, "metabolic features", "\n"))
# Assign a variable with the index of the first column corresponding to an MS signal
desineg_first_metabolite_idx_vmet2 <- 23

# VMET2 DESI-MS Positive Mode
cat(paste("VMET2 DESI-MS Positive Mode Matrix: ", dim(desi_pos_vmet2)[1], "samples, ", dim(desi_pos_vmet2)[2] - 23, "metabolic features", "\n"))
# Assign a variable with the index of the first column corresponding to an MS signal
desipos_first_metabolite_idx_vmet2 <- 23

# VMET DESI-MS Negative Mode
cat(paste("VMET DESI-MS Negative Mode Matrix: ", dim(desi_neg_vmet)[1], "samples, ", dim(desi_neg_vmet)[2] - 22, "metabolic features", "\n"))
# Assign a variable with the index of the first column corresponding to an MS signal
desineg_first_metabolite_idx_vmet <- 22

# VMET DESI-MS Positive Mode
cat(paste("VMET DESI-MS Positive Mode Matrix: ", dim(desi_pos_vmet)[1], "samples, ", dim(desi_pos_vmet)[2] - 22, "metabolic features", "\n"))
# Assign a variable with the index of the first column corresponding to an MS signal
desipos_first_metabolite_idx_vmet <- 22
```

# Mass spectrometry data - quality assessment 
Criteria 1 - Proportion of TIC (Total Ion Current) corresponding to solvent and contaminants. Spectra with low intensity and less detected peaks are expected to have a higher proportion of their TIC made up of signals from non-biologically relevant features, such as swab polymers and DESI-solvent ions.
```{r}
# Empirical m/z values observed in each dataset for a series of solvent and swab polymer signals.
vmet_solvent_masses_neg <- c('X255.2330343', 'X265.1480388', 'X283.2643228', 'X293.1794557', 'X311.1687117', 'X325.1842614', 'X339.2000691')
vmet2_solvent_masses_neg <- c('X255.2329265', 'X265.147886', 'X283.2642262', 'X293.1792042', 'X311.1686239', 'X325.1842963', 'X339.1998989')


vmet_solvent_masses_pos <- c('X309.2035476', 'X337.1048538', 'X349.183855', 'X365.1467875', 'X381.1301028', 
                             'X393.2100358', 'X437.236176', 'X481.2618261', 'X525.2884281',
                             'X569.3137243', 'X613.3396503', 'X675.4498523', 'X703.4969175', 'X747.523259', 'X791.553707')

vmet2_solvent_masses_pos <- c('X309.2029342', 'X337.1039783', 'X349.1826681', 'X365.1355897', 'X381.1298388', 
                             'X393.2088477', 'X437.2351681', 'X481.2606237', 'X525.2873197', 'X569.3146225', 'X613.3400322', 'X675.4461929', 
                             'X703.4968554', 'X747.5227917', 'X791.5521427')

# Calculate the TIC (row-wise sum of all columns)
TIC_vmet_neg <- rowSums(desi_neg_vmet[, desineg_first_metabolite_idx_vmet:dim(desi_neg_vmet)[2]])
TIC_vmet2_neg <- rowSums(desi_neg_vmet2[, desineg_first_metabolite_idx_vmet2:dim(desi_neg_vmet2)[2]])

TIC_vmet_pos <- rowSums(desi_pos_vmet[, desipos_first_metabolite_idx_vmet:dim(desi_pos_vmet)[2]])
TIC_vmet2_pos <- rowSums(desi_pos_vmet2[, desipos_first_metabolite_idx_vmet2:dim(desi_pos_vmet2)[2]])

# Calculate the Total Ion current using only the solvent and polymer masses (row-wise sum of selected solvent/polymer signals)
solvent_IC_vmet_neg <- rowSums(desi_neg_vmet[, vmet_solvent_masses_neg])
solvent_IC_vmet2_neg <- rowSums(desi_neg_vmet2[, vmet2_solvent_masses_neg])

solvent_IC_vmet_pos <- rowSums(desi_pos_vmet[, vmet_solvent_masses_pos])
solvent_IC_vmet2_pos <- rowSums(desi_pos_vmet2[, vmet2_solvent_masses_pos])

# Ratio of Solvent/Polymer Ion current to Total Ion current. Spectra with a ratio closer to 1 have their spectrum dominated
# by background 
solventTIC_ratio_vmet_neg <- solvent_IC_vmet_neg/TIC_vmet_neg
solventTIC_ratio_vmet2_neg <- solvent_IC_vmet2_neg/TIC_vmet2_neg

solventTIC_ratio_vmet_pos <- solvent_IC_vmet_pos/TIC_vmet_pos
solventTIC_ratio_vmet2_pos <- solvent_IC_vmet2_pos/TIC_vmet2_pos

# Create dataframes for export with all the QC metrics for each DESI-MS Spectrum ID
vmet2_qc_neg <- data.frame(DESI_ID=desi_neg_vmet2$DESI_ID, 
           TIC=TIC_vmet2_neg, Solvent_Integral=solvent_IC_vmet2_neg, Solvent_TIC_Percentage=solventTIC_ratio_vmet2_neg*100)

vmet_qc_neg <- data.frame(DESI_ID=desi_neg_vmet$DESI_ID, TIC=TIC_vmet_neg, Solvent_Integral=solvent_IC_vmet_neg, Solvent_TIC_Percentage=solventTIC_ratio_vmet_neg*100)

vmet2_qc_pos <- data.frame(DESI_ID=desi_pos_vmet2$DESI_ID, TIC=TIC_vmet2_pos, Solvent_Integral=solvent_IC_vmet2_pos,                         Solvent_TIC_Percentage=solventTIC_ratio_vmet2_pos*100)

vmet_qc_pos <- data.frame(DESI_ID=desi_pos_vmet$DESI_ID, TIC=TIC_vmet_pos, Solvent_Integral=solvent_IC_vmet_pos, Solvent_TIC_Percentage=solventTIC_ratio_vmet_pos*100)

# Define an upper cut-off for % of TIC made up by solvent and polymer peaks.
# Fit a gaussian distribution to the solvent_TIC_%
vmet2_neg_solventTIC_norm <- MASS::fitdistr(x=vmet2_qc_neg$Solvent_TIC_Percentage, 'normal')
vmet_neg_solventTIC_norm <- MASS::fitdistr(x=vmet_qc_neg$Solvent_TIC_Percentage, 'normal')

vmet2_pos_solventTIC_norm <- MASS::fitdistr(x=vmet2_qc_pos$Solvent_TIC_Percentage, 'normal')
vmet_pos_solventTIC_norm <- MASS::fitdistr(x=vmet_qc_pos$Solvent_TIC_Percentage, 'normal')

# Cutt-off is Mean + 2*std
vmet2_neg_solvent_Cutoff <- vmet2_neg_solventTIC_norm$estimate[1] + 2*vmet2_neg_solventTIC_norm$estimate[2]
vmet_neg_solvent_Cutoff <- vmet_neg_solventTIC_norm$estimate[1] + 2*vmet_neg_solventTIC_norm$estimate[2]

vmet2_pos_solvent_Cutoff <- vmet2_pos_solventTIC_norm$estimate[1] + 2*vmet2_pos_solventTIC_norm$estimate[2]
vmet_pos_solvent_Cutoff <- vmet_pos_solventTIC_norm$estimate[1] + 2*vmet_pos_solventTIC_norm$estimate[2]

vmet2_qc_neg$Exclude_SolventTIC <- vmet2_qc_neg$Solvent_TIC_Percentage > vmet2_neg_solvent_Cutoff
vmet_qc_neg$Exclude_SolventTIC <- vmet_qc_neg$Solvent_TIC_Percentage > vmet_neg_solvent_Cutoff
vmet2_qc_pos$Exclude_SolventTIC <- vmet2_qc_pos$Solvent_TIC_Percentage > vmet2_pos_solvent_Cutoff
vmet_qc_pos$Exclude_SolventTIC <- vmet_qc_pos$Solvent_TIC_Percentage > vmet_pos_solvent_Cutoff

rm(vmet2_neg_solventTIC_norm)
rm(vmet_neg_solventTIC_norm)
rm(vmet2_pos_solventTIC_norm)
rm(vmet_pos_solventTIC_norm)

# Diagnostic plots 
ggplot(vmet2_qc_neg, aes(x=1:nrow(vmet2_qc_neg) , y=Solvent_TIC_Percentage[order(Solvent_TIC_Percentage)])) + geom_point() + geom_hline(aes(yintercept=vmet2_neg_solvent_Cutoff)) + xlab('Rank') + ylab('Solvent/Polymer % of TIC') + ggtitle('VMET2 DESI-MS Negative Mode')
cat(paste0('VMET2 DESI-NEG:  N. Spectra excluded due to high solvent/polymer % of TIC: ', sum(vmet2_qc_neg$Solvent_TIC_Percentage > vmet2_neg_solvent_Cutoff)))

ggplot(vmet_qc_neg, aes(x=1:nrow(vmet_qc_neg) , y=Solvent_TIC_Percentage[order(Solvent_TIC_Percentage)])) + geom_point() + geom_hline(aes(yintercept=vmet_neg_solvent_Cutoff)) + xlab('Rank') + ylab('Solvent/Polymer % of TIC') + ggtitle('VMET DESI-MS Negative Mode')
cat(paste0('VMET DESI-NEG:  N. Spectra excluded due to high solvent/polymer % of TIC: ', sum(vmet_qc_neg$Solvent_TIC_Percentage > vmet_neg_solvent_Cutoff)))

ggplot(vmet2_qc_pos, aes(x=1:nrow(vmet2_qc_pos) , y=Solvent_TIC_Percentage[order(Solvent_TIC_Percentage)])) + geom_point() + geom_hline(aes(yintercept=vmet2_pos_solvent_Cutoff)) + xlab('Rank') + ylab('Solvent/Polymer % of TIC') + ggtitle('VMET2 DESI-MS Positive Mode')
cat(paste0('VMET2 DESI-POS:  N. Spectra excluded due to high solvent/polymer % of TIC: ', sum(vmet2_qc_pos$Solvent_TIC_Percentage > vmet2_pos_solvent_Cutoff)))

ggplot(vmet_qc_pos, aes(x=1:nrow(vmet_qc_pos) , y=Solvent_TIC_Percentage[order(Solvent_TIC_Percentage)])) + geom_point() + geom_hline(aes(yintercept=vmet_pos_solvent_Cutoff)) + xlab('Rank') + ylab('Solvent/Polymer % of TIC') + ggtitle('VMET DESI-MS Positive Mode')
cat(paste0('VMET DESI-POS:  N. Spectra excluded due to high solvent/polymer % of TIC: ', sum(vmet_qc_pos$Solvent_TIC_Percentage > vmet_pos_solvent_Cutoff)))
```

Criteria 2 - Proportion of non-zero features per spectrum. Low quality spectra are expected to have a higher proportion of missing values (recorded as 0s in the DESI-MS data matrices). 
```{r}
# Total number of MS signals per data matrix to estimate Non zero percentages
n_metabolites_vmet2_neg <- length(desineg_first_metabolite_idx_vmet2:dim(desi_neg_vmet2)[2])
n_metabolites_vmet_neg <- length(desineg_first_metabolite_idx_vmet:dim(desi_neg_vmet)[2])

n_metabolites_vmet2_pos <- length(desipos_first_metabolite_idx_vmet2:dim(desi_pos_vmet2)[2])
n_metabolites_vmet_pos <- length(desipos_first_metabolite_idx_vmet:dim(desi_pos_vmet)[2])

# Number of peaks 
non_zero_vmet_neg <- rowSums(desi_neg_vmet[, desineg_first_metabolite_idx_vmet:dim(desi_neg_vmet)[2]] > 0)
non_zero_vmet2_neg <- rowSums(desi_neg_vmet2[, desineg_first_metabolite_idx_vmet2:dim(desi_neg_vmet2)[2]] > 0)

non_zero_vmet_pos <- rowSums(desi_pos_vmet[, desipos_first_metabolite_idx_vmet:dim(desi_pos_vmet)[2]] > 0)
non_zero_vmet2_pos <- rowSums(desi_pos_vmet2[, desipos_first_metabolite_idx_vmet2:dim(desi_pos_vmet2)[2]] > 0)

# Estimate a ratio of non-zero peaks
non_zero_ratio_vmet2_neg <- (non_zero_vmet2_neg/n_metabolites_vmet2_neg)
non_zero_ratio_vmet_neg <- (non_zero_vmet_neg/n_metabolites_vmet_neg)
non_zero_ratio_vmet2_pos <- (non_zero_vmet2_pos/n_metabolites_vmet2_pos)
non_zero_ratio_vmet_pos <- (non_zero_vmet_pos/n_metabolites_vmet_pos)

# Add new information to data frames
vmet2_qc_neg$Non_Zero_Peaks <- non_zero_vmet2_neg
vmet2_qc_neg$Non_Zero_Percentage <- (non_zero_vmet2_neg/n_metabolites_vmet2_neg)*100

vmet_qc_neg$Non_Zero_Peaks <- non_zero_vmet_neg
vmet_qc_neg$Non_Zero_Percentage <- (non_zero_vmet_neg/n_metabolites_vmet_neg)*100

vmet2_qc_pos$Non_Zero_Peaks <- non_zero_vmet2_neg
vmet2_qc_pos$Non_Zero_Percentage <- (non_zero_vmet2_neg/n_metabolites_vmet2_neg)*100

vmet_qc_pos$Non_Zero_Peaks <- non_zero_vmet_pos
vmet_qc_pos$Non_Zero_Percentage <- (non_zero_vmet_pos/n_metabolites_vmet_pos)*100

# Define a lower cut-off for % of non zero.
# Fit a gaussian distribution to non-zero percentages in the dataset
# negative mode spectra
vmet2_neg_zero_norm <- MASS::fitdistr(x=vmet2_qc_neg$Non_Zero_Percentage, 'normal')
vmet_neg_zero_norm <- MASS::fitdistr(x=vmet_qc_neg$Non_Zero_Percentage, 'normal')

# positive mode spectra
vmet2_pos_zero_norm <- MASS::fitdistr(x=vmet2_qc_pos$Non_Zero_Percentage, 'normal')
vmet_pos_zero_norm <- MASS::fitdistr(x=vmet_qc_pos$Non_Zero_Percentage, 'normal')

# Cutt-off is Mean - 2*std
vmet2_neg_nonzero_Cutoff <- vmet2_neg_zero_norm$estimate[1] - 2*vmet2_neg_zero_norm$estimate[2]
vmet_neg_nonzero_Cutoff <- vmet_neg_zero_norm$estimate[1] - 2*vmet_neg_zero_norm$estimate[2]

vmet2_pos_nonzero_Cutoff <- vmet2_pos_zero_norm$estimate[1] - 2*vmet2_pos_zero_norm$estimate[2]
vmet_pos_nonzero_Cutoff <- vmet_pos_zero_norm$estimate[1] - 2*vmet_pos_zero_norm$estimate[2]

vmet2_qc_neg$Exclude_NonZero_Percentage <- vmet2_qc_neg$Non_Zero_Percentage < vmet2_neg_nonzero_Cutoff
vmet_qc_neg$Exclude_NonZero_Percentage <- vmet_qc_neg$Non_Zero_Percentage < vmet_neg_nonzero_Cutoff
vmet2_qc_pos$Exclude_NonZero_Percentage <- vmet2_qc_pos$Non_Zero_Percentage < vmet2_pos_nonzero_Cutoff
vmet_qc_pos$Exclude_NonZero_Percentage <- vmet_qc_pos$Non_Zero_Percentage < vmet_pos_nonzero_Cutoff

rm(vmet2_neg_zero_norm)
rm(vmet_neg_zero_norm)
rm(vmet2_pos_zero_norm)
rm(vmet_pos_zero_norm)

# Diagnostic plots 
ggplot(vmet2_qc_neg, aes(x=1:nrow(vmet2_qc_neg) , y=Non_Zero_Percentage[order(Non_Zero_Percentage)])) + geom_point() + geom_hline(aes(yintercept=vmet2_neg_nonzero_Cutoff)) + xlab('Rank') + ylab('% of Non-zero signals') + ggtitle('VMET2 DESI-MS Negative Mode')
cat(paste0('VMET2 DESI-NEG:  N. Spectra excluded due to low % of Non-zero signals: ', sum(vmet2_qc_neg$Exclude_NonZero_Percentage)))

ggplot(vmet_qc_neg, aes(x=1:nrow(vmet_qc_neg) , y=Non_Zero_Percentage[order(Non_Zero_Percentage)])) + geom_point() + geom_hline(aes(yintercept=vmet_neg_nonzero_Cutoff)) + xlab('Rank') + ylab('% of Non-zero signals') + ggtitle('VMET DESI-MS Negative Mode')
cat(paste0('VMET DESI-NEG:  N. Spectra excluded due to low % of Non-zero signals: ', sum(vmet_qc_neg$Exclude_NonZero_Percentage)))

ggplot(vmet2_qc_pos, aes(x=1:nrow(vmet2_qc_pos) , y=Non_Zero_Percentage[order(Non_Zero_Percentage)])) + geom_point() + geom_hline(aes(yintercept=vmet2_pos_nonzero_Cutoff)) + xlab('Rank') + ylab('% of Non-zero signals') + ggtitle('VMET2 DESI-MS Positive Mode')
cat(paste0('VMET2 DESI-POS:  N. Spectra excluded due to low % of Non-zero signals: ', sum(vmet2_qc_pos$Exclude_NonZero_Percentage)))

ggplot(vmet_qc_pos, aes(x=1:nrow(vmet_qc_pos) , y=Non_Zero_Percentage[order(Non_Zero_Percentage)])) + geom_point() + geom_hline(aes(yintercept=vmet_pos_nonzero_Cutoff)) + xlab('Rank') + ylab('% of Non-zero signals') + ggtitle('VMET DESI-MS Positive Mode')
cat(paste0('VMET DESI-POS:  N. Spectra excluded due to low % of Non-zero signals: ', sum(vmet_qc_pos$Exclude_NonZero_Percentage)))
```


Exporting the QC results
```{r}
vmet2_qc_neg$Exclude <- vmet2_qc_neg$Exclude_SolventTIC | vmet2_qc_neg$Exclude_NonZero_Percentage
vmet_qc_neg$Exclude <- vmet_qc_neg$Exclude_SolventTIC | vmet_qc_neg$Exclude_NonZero_Percentage
vmet2_qc_pos$Exclude <- vmet2_qc_pos$Exclude_SolventTIC | vmet2_qc_pos$Exclude_NonZero_Percentage
vmet_qc_pos$Exclude <- vmet_qc_pos$Exclude_SolventTIC | vmet_qc_pos$Exclude_NonZero_Percentage

cat(paste0('VMET2 DESI-NEG:  N. Spectra excluded: ', sum(vmet2_qc_neg$Exclude)))
cat(paste0('VMET DESI-NEG:  N. Spectra excluded: ', sum(vmet_qc_neg$Exclude)))
cat(paste0('VMET2 DESI-POS:  N. Spectra excluded: ', sum(vmet2_qc_pos$Exclude)))
cat(paste0('VMET DESI-POS:  N. Spectra excluded: ', sum(vmet_qc_pos$Exclude)))

# Save the results to a dataframe
write.csv(vmet2_qc_neg, './DESI-MS QC/VMET2_DESI_Negative_QC.csv',row.names = F)
write.csv(vmet_qc_neg, './DESI-MS QC/VMET_DESI_Negative_QC.csv',row.names = F)

write.csv(vmet2_qc_pos, './DESI-MS QC/VMET2_DESI_Positive_QC.csv',row.names = F)
write.csv(vmet_qc_pos, './DESI-MS QC/VMET_DESI_Positive_QC.csv',row.names = F)
```