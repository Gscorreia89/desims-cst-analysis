---
title: "CST Typing by DESI-MS - Detection of Lactobacillus Depleted Status"
output: html_notebook
---

```{r "setup", include=FALSE}
require("knitr")
opts_knit$set(root.dir='./')
```

### Load the required packages
```{r, include=FALSE}
library(ggplot2)
library(doParallel)
library(readr)
library(reshape2)
library(caret)
library(randomForest)
library(plotROC)
library(pROC)
library(precrec)
set.seed(13522848)
# Set ggplot titles to appear at center
ggplot() + theme(plot.title = element_text(hjust = 'center'))
registerDoParallel(cores=22)
dir.create('./Lactobacillus_Depleted_Detection_DESI-MS/', recursive=TRUE)
dir.create('./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/', recursive=TRUE)
dir.create('./Lactobacillus_Depleted_Detection_DESI-MS/Precision_Recall_Curves/', recursive=TRUE)
```

# Data import
### Load the VMET2 DESI-MS Positive and Negative mode datasets 
```{r, warning=F, echo=F, message=F}
# Load the datasets
desi_neg_vmet2 <- read.table("../../Data/VMET2_DESI-MS_NEG.csv", header=1, sep=',')
desi_pos_vmet2 <- read.table("../../Data/VMET2_DESI-MS_POS.csv", header=1, sep=',')

# Load the Study Metadata
study_metadata_vmet2 <- read_csv("../../Data/VMET2_Metadata.csv")
cst_metadata_vmet2 <- read_csv("../../Data/VMET2_CSTAssignment.csv")

study_metadata_vmet2 <- merge(study_metadata_vmet2, cst_metadata_vmet2, by='Seq_ID')

# Merge with the clinical metadata
desi_pos_vmet2 <- merge(study_metadata_vmet2, desi_pos_vmet2, by.x="DESI_ID", by.y="DESI_ID", sort=FALSE)
desi_neg_vmet2 <- merge(study_metadata_vmet2, desi_neg_vmet2, by.x="DESI_ID", by.y="DESI_ID", sort=FALSE)
colnames(desi_pos_vmet2)[colnames(desi_pos_vmet2) == 'Seq_ID.x'] <- 'Seq_ID'
colnames(desi_neg_vmet2)[colnames(desi_neg_vmet2) == 'Seq_ID.x'] <- 'Seq_ID'

# Load the data QC results and exclude samples with low spectral quality
desi_neg_vmet2_QC <- read.table("./DESI-MS QC/VMET2_DESI_Negative_QC.csv", header=1, sep=',')
desi_pos_vmet2_QC <- read.table("./DESI-MS QC/VMET2_DESI_Positive_QC.csv", header=1, sep=',')

# Exclude the samples flagged in the DESI-MS Data QC Notebook
neg_vmet2_exclusions <- desi_neg_vmet2_QC[desi_neg_vmet2_QC$Exclude == TRUE, 'DESI_ID']
pos_vmet2_exclusions <- desi_neg_vmet2_QC[desi_pos_vmet2_QC$Exclude == TRUE, 'DESI_ID']
desi_neg_vmet2 <- desi_neg_vmet2[!(desi_neg_vmet2$DESI_ID %in% neg_vmet2_exclusions), ]
desi_pos_vmet2 <- desi_pos_vmet2[!(desi_pos_vmet2$DESI_ID %in% pos_vmet2_exclusions), ]

# remove intermediate variables
rm(study_metadata_vmet2)
rm(cst_metadata_vmet2)
rm(desi_neg_vmet2_QC)
rm(desi_pos_vmet2_QC)
rm(neg_vmet2_exclusions)
rm(pos_vmet2_exclusions)
```

### Load the VMET DESI-MS Positive and Negative mode datasets
```{r, warning=F, echo=F, message=F}
# Load the DESI-MS datasets
desi_neg_vmet <- read.table("../../Data/VMET_DESI-MS_NEG.csv", header=1, sep=',')
desi_pos_vmet <- read.table("../../Data/VMET_DESI-MS_POS.csv", header=1, sep=',')

# Load the Study Metadata
study_metadata_vmet <- read_csv("../../Data/VMET_Metadata.csv")
cst_metadata_vmet <- read_csv("../../Data/VMET_CSTAssignment.csv")

study_metadata_vmet <- merge(study_metadata_vmet, cst_metadata_vmet, by='Seq_ID')

# Merge with the clinical metadata
desi_pos_vmet <- merge(study_metadata_vmet, desi_pos_vmet, by.x="DESI_ID", by.y="DESI_ID", sort=FALSE)
desi_neg_vmet <- merge(study_metadata_vmet, desi_neg_vmet, by.x="DESI_ID", by.y="DESI_ID", sort=FALSE)
colnames(desi_pos_vmet)[colnames(desi_pos_vmet) == 'Seq_ID.x'] <- 'Seq_ID'
colnames(desi_neg_vmet)[colnames(desi_neg_vmet) == 'Seq_ID.x'] <- 'Seq_ID'

# Load the data QC results and exclude samples with low spectral quality
desi_neg_vmet_QC <- read.table("./DESI-MS QC/VMET_DESI_Negative_QC.csv", header=1, sep=',')
desi_pos_vmet_QC <- read.table("./DESI-MS QC/VMET_DESI_Positive_QC.csv", header=1, sep=',')

# Exclude the samples flagged in the DESI-MS Data QC Notebook
neg_vmet_exclusions <- desi_neg_vmet_QC[desi_neg_vmet_QC$Exclude == TRUE, 'DESI_ID']
pos_vmet_exclusions <- desi_pos_vmet_QC[desi_pos_vmet_QC$Exclude == TRUE, 'DESI_ID']
desi_neg_vmet <- desi_neg_vmet[!(desi_neg_vmet$DESI_ID %in% neg_vmet_exclusions), ]
desi_pos_vmet <- desi_pos_vmet[!(desi_pos_vmet$DESI_ID %in% pos_vmet_exclusions), ]

# remove intermediate variables
rm(study_metadata_vmet)
rm(cst_metadata_vmet)
rm(desi_neg_vmet_QC)
rm(desi_pos_vmet_QC)
rm(neg_vmet_exclusions)
rm(pos_vmet_exclusions)
```

### Quick overview of dataset dimensions and indexes
```{r}
# VMET2 DESI-MS Negative Mode
# Assign a variable with the index of the first column corresponding to an MS signal, helpful to select only metabolic variables in each dataset in subsequent analyses.
desineg_first_metabolite_idx_vmet2 <- 29
cat(paste("VMET2 DESI-MS Negative Mode Matrix: ", dim(desi_neg_vmet2)[1], "samples, ", dim(desi_neg_vmet2)[2] - 29, "metabolic features", "\n"))

# VMET2 DESI-MS Positive Mode
desipos_first_metabolite_idx_vmet2 <- 29
cat(paste("VMET2 DESI-MS Positive Mode Matrix: ", dim(desi_pos_vmet2)[1], "samples, ", dim(desi_pos_vmet2)[2] - 29, "metabolic features", "\n"))
# Assign a variable with the index of the first column corresponding to an MS signal

# VMET DESI-MS Negative Mode
desineg_first_metabolite_idx_vmet <- 28
cat(paste("VMET DESI-MS Negative Mode Matrix: ", dim(desi_neg_vmet)[1], "samples, ", dim(desi_neg_vmet)[2] - 28, "metabolic features", "\n"))
# Assign a variable with the index of the first column corresponding to an MS signal

# VMET DESI-MS Positive Mode
desipos_first_metabolite_idx_vmet <- 28
cat(paste("VMET DESI-MS Positive Mode Matrix: ", dim(desi_pos_vmet)[1], "samples, ", dim(desi_pos_vmet)[2] - 28, "metabolic features", "\n"))
# Assign a variable with the index of the first column corresponding to an MS signal
```
# Detection of "Lactobacillus depleted" microbiome state using the DESI-MS profiles.
In this analysis, the DESI-MS profiles from the VMET2 and VMET datasets are used to predict whether the microbial composition is dominated by Lactobacillus species ("LDominant", as in Lactobacillus Dominant) vs other species (LDepleted, or Lactobacillus Depleted). The *random_forest_comparison_LDepleted_CST* and *random_forest_comparison_LDepleted_RelativeAbundance* functions defined in the next cell handle the model fitting and cross-validation. The interface from the *caret* package is used to fit the random forest models and perform a repeated (n=15 times) 7-fold stratified cross validation.

In the *_CST* suffixed function, the LDominant and LDepleted status are encoded as using the CST criteria (CST I, II, III and V = LDominant, IV and VI = LDepleted).

For the *_RelativeAbundance* method the % of total 16S counts from the Lactobacillus genera is used as the cut-off criteria (LDominant = > 85 % Lactobacillus counts, as assigned in the "/16S Analysis/VMET2 16S Analysis - Community State Type analysis" and "/16S Analysis/VMET 16S Analysis - Community State Type analysis" Jupyter notebooks). 
```{r}
# Lactobacillus depleted "LDepleted" (CST IV and VI/B.breve) vs Lactobacillus dominant "LDominant" (CST I, II, III, V and VII)
random_forest_comparison_LDepleted_CST <- function(dataset, first_metabo_idx) {
   
   # Extract metabolic features only and column stack with the y vector
   dataset_train <- dataset[, colnames(dataset)[first_metabo_idx:dim(dataset)[2]]]
   dataset_train <- cbind(LDepleted=dataset$LDominant_CST, dataset_train)
   
   # Replace NA's with 0 - not necessary...
   # dataset_train[is.na(dataset_train)] <- 0
   
   dataset_train$LDepleted <- factor(dataset_train$LDepleted)
   # 7-Fold cross-validation repeated 15 times.
   fit_control <- trainControl(method = "repeatedcv", repeats=15, classProbs = TRUE,
                              number = 7, summaryFunction=multiClassSummary, 
                              preProcOptions = c('center', 'scale'), savePredictions=TRUE)
   
   # ntree set to a "Large" number = 1000
   # mtry set here to a fixed rule of thumb value 1/3 of number of features (rule of thumb proposed in [1])
   rf_fit <- train(LDepleted ~ ., 
                   data = dataset_train, method='rf', trControl=fit_control, ntree=1000, metric='AUC', tuneGrid=data.frame(mtry=dim(dataset_train)[2]/3))
   
  return (rf_fit)
}

# Lactobacillus depleted "LDepleted" vs Lactobacillus Dominant, using the relative abundance criteria
random_forest_comparison_LDepleted_RelativeAbundance <- function(dataset, first_metabo_idx) {
   
   # Extract metabolic features only and column stack with the y vector
   dataset_train <- dataset[, colnames(dataset)[first_metabo_idx:dim(dataset)[2]]]
   dataset_train <- cbind(LDepleted=dataset$LDominant_RelAbundance, dataset_train)
   
   # Replace NA's with 0 - not necessary...
   # dataset_train[is.na(dataset_train)] <- 0
   
   dataset_train$LDepleted <- factor(dataset_train$LDepleted)
   
   fit_control <- trainControl(method = "repeatedcv", repeats=15, classProbs = TRUE,
                              number = 7, summaryFunction=multiClassSummary, 
                              preProcOptions = c('center', 'scale'), savePredictions=TRUE)
   
   # ntree set to a "Large" number = 1000
   # mtry set here to a fixed rule of thumb value 1/3 of number of features (rule of thumb proposed in [1])
   
   rf_fit <- train(LDepleted ~ ., 
                   data = dataset_train, method='rf', trControl=fit_control, ntree=1000, metric='AUC', tuneGrid=data.frame(mtry=dim(dataset_train)[2]/3))
   
  return (rf_fit)
}

# Helper function to calculate parameters for roc curves and generate quick plots for inspection
get_roc <- function(model, levels, target) {
  
    #cv_original_class <- model$trainingData$.outcome
    cv_original_class <- model$pred$obs
    #cv_predictor_avg <- aggregate(as.formula(paste(target, "~ rowIndex")),model$pred,mean)[,target]
    cv_predictor_avg <- model$pred[, target]
    roc_test_set <- roc(cv_original_class, cv_predictor_avg, ci=TRUE)
    roc_data <- data.frame(Class=cv_original_class,target=cv_predictor_avg)
    roc_plot <- ggplot(roc_data, 
    aes(m = target, d = factor(Class, levels = c(levels)), color='firebrick')) + guides(color = FALSE) + 
    geom_roc(hjust = 0, vjust = 0) + coord_equal() + style_roc(theme=theme_grey, xlab='1 - Specificity', ylab='Sensitivity') +  annotate("label", x = .75, y = .25, 
           label = paste("Mean AUC =", round(roc_test_set$auc, 2)), color='firebrick')
    
    return(list(data=roc_data, roc=roc_test_set, plot=roc_plot)) 
}

   # References
   # [1] Hastie, T., Tibshirani, R., & Friedman, J. (2009). The Elements of Statistical Learning. Elements, 1, 337â€“387. https://doi.org/10.1007/b94608

```

# Detection of Lactobacillus depleted state based on the DESI-MS profile.
Can DESI-MS data be used to predict the cervicovaginal microbiome status and discriminate Lactobacillus dominant vs Lactobacillus depleted status? 
To test this hypothesis, we train random forest classifiers to predict microbial composition (Y - target) from the DESI-MS metabolic profiles (X). This is done in the VMET and VMET2 cohorts, using each DESI-MS ionisation mode datasets independently. Models were validated with a repeated (n=15) stratified 7-fold cross-validation scheme, with area under the curve and other metrics calculated using only samples in the external cross-validation test-sets.

In this cell, the "Lactobacillus Dominant" or "Depleted" criteria used is based on the CST hierarchical clustering assignment. Samples with a CST IV or VI (B.breve) are considered "LDepleted", and all other CST as "LDominant".
```{r}
# Fit models to VMET2
LDepleted_desipos_vmet2 <- random_forest_comparison_LDepleted_CST(desi_pos_vmet2,  desipos_first_metabolite_idx_vmet2)
LDepleted_desineg_vmet2 <- random_forest_comparison_LDepleted_CST(desi_neg_vmet2, desineg_first_metabolite_idx_vmet2)
# Fit models to VMET
LDepleted_desipos_vmet <- random_forest_comparison_LDepleted_CST(desi_pos_vmet,  desipos_first_metabolite_idx_vmet)
LDepleted_desineg_vmet <- random_forest_comparison_LDepleted_CST(desi_neg_vmet, desineg_first_metabolite_idx_vmet)

# save the model performance metrics to .txt files
capture.output(print(LDepleted_desipos_vmet2), file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET2_DESI_POS_RF_Model_CST.txt')
capture.output(print(LDepleted_desipos_vmet), file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET_DESI_POS_RF_Model_CST.txt')
capture.output(print(LDepleted_desineg_vmet2), file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET2_DESI_NEG_RF_Model_CST.txt')
capture.output(print(LDepleted_desineg_vmet), file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET_DESI_NEG_RF_Model_CST.txt')

# ROC_Information
desipos_roc_vmet2 <- get_roc(LDepleted_desipos_vmet2, c('LDominant', 'LDepleted'), 'LDepleted')
desineg_roc_vmet2 <- get_roc(LDepleted_desineg_vmet2, c('LDominant', 'LDepleted'), 'LDepleted')

desipos_roc_vmet <- get_roc(LDepleted_desipos_vmet, c('LDominant', 'LDepleted'), 'LDepleted')
desineg_roc_vmet <- get_roc(LDepleted_desineg_vmet, c('LDominant', 'LDepleted'), 'LDepleted')

# Stack the roc curves on a dataframe for plotting
pos_roc_data_vmet2 <- cbind(desipos_roc_vmet2$data, Mode=rep('Positive', dim(desipos_roc_vmet2$data)[1]), Study=rep('VMET2', dim(desipos_roc_vmet2$data)[1]))
neg_roc_data_vmet2 <- cbind(desineg_roc_vmet2$data, Mode=rep('Negative', dim(desineg_roc_vmet2$data)[1]), Study=rep('VMET2', dim(desineg_roc_vmet2$data)[1]))

pos_roc_data_vmet <- cbind(desipos_roc_vmet$data, Mode=rep('Positive', dim(desipos_roc_vmet$data)[1]), Study=rep('VMET', dim(desipos_roc_vmet$data)[1]))
neg_roc_data_vmet <- cbind(desineg_roc_vmet$data, Mode=rep('Negative', dim(desineg_roc_vmet$data)[1]), Study=rep('VMET', dim(desineg_roc_vmet$data)[1]))

desi_roc_data <- rbind(pos_roc_data_vmet2, neg_roc_data_vmet2, pos_roc_data_vmet, neg_roc_data_vmet)

# Remove intermediate variables
rm(pos_roc_data_vmet2)
rm(neg_roc_data_vmet2)
rm(pos_roc_data_vmet)
rm(neg_roc_data_vmet)

desi_roc_data$Class <- factor(desi_roc_data$Class, levels = c('LDominant', 'LDepleted'))
desi_roc_data$Class <- as.numeric(desi_roc_data$Class) - 1
# Generate the ROC curve
roc_Ldepleted_desi <- ggplot(desi_roc_data, 
    aes(m = target, d = Class, color=Study, linetype=Mode)) + 
    geom_roc(hjust = 0, vjust = 0, labels=F) + coord_equal() + style_roc(theme=theme_grey, xlab='1 - Specificity', ylab='Sensitivity') + ggtitle('Detection of Lactobacillus Depleted State by DESI-MS') + scale_linetype_manual(values=c("dotted", "solid"))#+ annotate("label", x = c(.75), y = c(.25), parse=FALSE, label = roc_lab)

# Save the ROC curve
ggsave(filename='./Lactobacillus_Depleted_Detection_DESI-MS/DESI-MS_LactobacillusDepleted_CST_ROC.png', roc_Ldepleted_desi)
```

# Analysis of model predictions and classification uncertainty
After the model is trained we can assess individual predictions and misclassified samples. We use Out-of-bag (OOB) predictions to obtain a single prediction from 
the random forest classifier models.
This information is used in Supplementary data Figures 4 and 5.
## Analysis of sample misclassifications
### DESI-MS Negative mode predictions
```{r}
# Select the final model trained on all data
desiNeg_VMET2_RFModel <- LDepleted_desineg_vmet2$finalModel
desiNeg_VMET_RFModel <- LDepleted_desineg_vmet$finalModel

# Get the out-of-bag prediction
oob_prediction_VMET <- predict(desiNeg_VMET_RFModel)
oob_prediction_VMET2 <- predict(desiNeg_VMET2_RFModel)
# Get the continuous "probability" measure per class
oob_prediction_VMET_probability <- predict(desiNeg_VMET_RFModel, type='prob')
oob_prediction_VMET2_probability <- predict(desiNeg_VMET2_RFModel, type='prob')

# Subset only the relevant metadata and add an LDepleted/LDominant factor
vmet_DesiNeg_Metatadata <- desi_neg_vmet[, c("DESI_ID", "Seq_ID", "CST", "LDominant_CST", "LDominant_RelAbundance", "LactobacillusPercentage", "SubjectID", "Timepoint", "Outcome", "GestationalAge", "Ethnicity")]

vmet2_DesiNeg_Metatadata <- desi_neg_vmet2[, c("DESI_ID", "Seq_ID", "CST", "CST_11", "LDominant_CST", "LDominant_RelAbundance", "LactobacillusPercentage", "SubjectID", "Timepoint", "Outcome", "GestationalAge", "Ethnicity")]

# Stack into dataframes
vmet2_prediction_results_all <- cbind(vmet2_DesiNeg_Metatadata, ModelOOBPrediction=oob_prediction_VMET2, ModelOOBDepletedProb=oob_prediction_VMET2_probability[, 1], ModelOOBDominantProb=oob_prediction_VMET2_probability[, 2])
vmet2_prediction_results_all$Misclassified <- vmet2_prediction_results_all$LDominant_CST != vmet2_prediction_results_all$ModelOOBPrediction

vmet_prediction_results_all <- cbind(vmet_DesiNeg_Metatadata, ModelOOBPrediction=oob_prediction_VMET, ModelOOBDepletedProb=oob_prediction_VMET_probability[, 1], ModelOOBDominantProb=oob_prediction_VMET_probability[, 2])
vmet_prediction_results_all$Misclassified <- vmet_prediction_results_all$LDominant_CST != vmet_prediction_results_all$ModelOOBPrediction
# Write to .csv file
write.csv(x = vmet2_prediction_results_all,file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET2_FinalModelLDepleted_Predictions_CST.csv')
write.csv(x = vmet_prediction_results_all, file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET_FinalModelLDepleted_Predictions_CST.csv')
```

### DESI-MS Positive mode predictions
```{r}
# Select the final model trained on all data
desiPos_VMET2_RFModel <- LDepleted_desipos_vmet2$finalModel
desiPos_VMET_RFModel <- LDepleted_desipos_vmet$finalModel

# Get the out-of-bag prediction
oob_prediction_VMET <- predict(desiPos_VMET_RFModel)
oob_prediction_VMET2 <- predict(desiPos_VMET2_RFModel)
# Get the continuous "probability" measure per class
oob_prediction_VMET_probability <- predict(desiPos_VMET_RFModel, type='prob')
oob_prediction_VMET2_probability <- predict(desiPos_VMET2_RFModel, type='prob')

# Subset only the relevant metadata and add an LDepleted/LDominant factor
vmet_DesiPos_Metatadata <- desi_pos_vmet[, c("DESI_ID", "Seq_ID", "CST", "LDominant_CST", "LDominant_RelAbundance", "LactobacillusPercentage", "SubjectID", "Timepoint", "Outcome", "GestationalAge", "Ethnicity")]

vmet2_DesiPos_Metatadata <- desi_pos_vmet2[, c("DESI_ID", "Seq_ID", "CST", "CST_11",  "LDominant_CST", "LDominant_RelAbundance", "LactobacillusPercentage", "SubjectID", "Timepoint", "Outcome", "GestationalAge", "Ethnicity")]

# Stack into dataframes
vmet2_prediction_results_all_pos <- cbind(vmet2_DesiPos_Metatadata, ModelOOBPrediction=oob_prediction_VMET2, ModelOOBDepletedProb=oob_prediction_VMET2_probability[, 1], ModelOOBDominantProb=oob_prediction_VMET2_probability[, 2])
vmet2_prediction_results_all$Misclassified <- vmet2_prediction_results_all$LDominant_RelAbundance != vmet2_prediction_results_all$ModelOOBPrediction

vmet_prediction_results_all_pos <- cbind(vmet_DesiPos_Metatadata, ModelOOBPrediction=oob_prediction_VMET, ModelOOBDepletedProb=oob_prediction_VMET_probability[, 1], ModelOOBDominantProb=oob_prediction_VMET_probability[, 2])
vmet_prediction_results_all$Misclassified <- vmet_prediction_results_all$LDominant_RelAbundance != vmet_prediction_results_all$ModelOOBPrediction

# Write to .csv file
write.csv(x = vmet2_prediction_results_all_pos,file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET2_FinalModelLDepleted_Predictions_CST_PositiveMode.csv')
write.csv(x = vmet_prediction_results_all_pos,file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET_FinalModelLDepleted_Predictions_CST_PositiveMode.csv')

```

## Precision-Recall curves
The code in this cell generates precision-recall curves for the LDominant and LDepleted class for each of the DESI-MS datasets. These figures form part of Supplementary Data Figure 3.
```{r}
# DESI-MS Negative mode
mmdata_vmet2_Ldep <- mmdata(vmet2_prediction_results_all$ModelOOBDepletedProb, vmet2_prediction_results_all$LDominant_CST, modnames = c("LDepleted"), posclass = 'LDepleted')
mmdata_vmet2_Ldom <- mmdata(vmet2_prediction_results_all$ModelOOBDominantProb, vmet2_prediction_results_all$LDominant_CST, modnames = c("LDominant"), posclass = 'LDominant')

mmdata_vmet_Ldep <- mmdata(vmet_prediction_results_all$ModelOOBDepletedProb, vmet_prediction_results_all$LDominant_CST, modnames = c("LDepleted"), posclass = 'LDepleted')
mmdata_vmet_Ldom <- mmdata(vmet_prediction_results_all$ModelOOBDominantProb, vmet_prediction_results_all$LDominant_CST, modnames = c("LDominant"), posclass = 'LDominant')

# Save Precision_Recall curves for VMET2_DESI_datasets
ggsave('./Lactobacillus_Depleted_Detection_DESI-MS/Precision_Recall_Curves/VMET2_Precision_Recall_Curve_LDom_DESI_NEG.png', autoplot(evalmod(mmdata_vmet2_Ldom), 'prc'))
ggsave('./Lactobacillus_Depleted_Detection_DESI-MS/Precision_Recall_Curves/VMET2_Precision_Recall_Curve_LDep_DESI_NEG.png', autoplot(evalmod(mmdata_vmet2_Ldep), 'prc'))

# Save Precision_Recall curves for VMET_DESI_datasets
ggsave('./Lactobacillus_Depleted_Detection_DESI-MS/Precision_Recall_Curves/VMET_Precision_Recall_Curve_LDom_DESI_NEG.png', autoplot(evalmod(mmdata_vmet_Ldom), 'prc'))
ggsave('./Lactobacillus_Depleted_Detection_DESI-MS/Precision_Recall_Curves/VMET_Precision_Recall_Curve_LDep_DESI_NEG.png', autoplot(evalmod(mmdata_vmet_Ldep), 'prc'))

# DESI-MS Positive Mode
mmdata_vmet2_Ldep_pos <- mmdata(vmet2_prediction_results_all_pos$ModelOOBDepletedProb, vmet2_prediction_results_all_pos$LDominant_CST, modnames = c("LDepleted"), posclass = 'LDepleted')
mmdata_vmet2_Ldom_pos <- mmdata(vmet2_prediction_results_all_pos$ModelOOBDominantProb, vmet2_prediction_results_all_pos$LDominant_CST, modnames = c("LDominant"), posclass = 'LDominant')

mmdata_vmet_Ldep_pos <- mmdata(vmet_prediction_results_all_pos$ModelOOBDepletedProb, vmet_prediction_results_all_pos$LDominant_CST, modnames = c("LDepleted"), posclass = 'LDepleted')
mmdata_vmet_Ldom_pos <- mmdata(vmet_prediction_results_all_pos$ModelOOBDominantProb, vmet_prediction_results_all_pos$LDominant_CST, modnames = c("LDominant"), posclass = 'LDominant')

# Save Precision_Recall curves for VMET2_DESI_datasets
ggsave('./Lactobacillus_Depleted_Detection_DESI-MS/Precision_Recall_Curves/VMET2_Precision_Recall_Curve_LDom_DESI_POS.png', autoplot(evalmod(mmdata_vmet2_Ldom_pos), 'prc'))
ggsave('./Lactobacillus_Depleted_Detection_DESI-MS/Precision_Recall_Curves/VMET2_Precision_Recall_Curve_LDep_DESI_POS.png', autoplot(evalmod(mmdata_vmet2_Ldep_pos), 'prc'))

# Save Precision_Recall curves for VMET_DESI_datasets
ggsave('./Lactobacillus_Depleted_Detection_DESI-MS/Precision_Recall_Curves/VMET_Precision_Recall_Curve_LDom_DESI_POS.png', autoplot(evalmod(mmdata_vmet_Ldom_pos), 'prc'))
ggsave('./Lactobacillus_Depleted_Detection_DESI-MS/Precision_Recall_Curves/VMET_Precision_Recall_Curve_LDep_DESI_POS.png', autoplot(evalmod(mmdata_vmet_Ldep_pos), 'prc'))
```
## Supplementary analysis - Relative Abundance alternative to Hierarchical clustering CST assignment
In this cell, we repeat the "Lactobacillus Dominant" vs "Depleted" classification models, but using the "LDominant" vs "LDepleted" classification obtained from the relative abundance of Lactobacillus species in the 16s profile. Since its hard to define an objective cut-off for LDominant vs LDepleted based on relative abundance of Lactobacillus species, the CST based assignment of LDominant vs LDepleted is preferred. Nevertheless, the ROC curves and area-under-the curve obtained with this definition are similar to those obtained from the CST-based criteria.
```{r}
# Fit models to VMET2 
LDepleted_desipos_vmet2 <- random_forest_comparison_LDepleted_RelativeAbundance(desi_pos_vmet2,  desipos_first_metabolite_idx_vmet2)
LDepleted_desineg_vmet2 <- random_forest_comparison_LDepleted_RelativeAbundance(desi_neg_vmet2, desineg_first_metabolite_idx_vmet2)
# Fit models to VMET
LDepleted_desipos_vmet <- random_forest_comparison_LDepleted_RelativeAbundance(desi_pos_vmet,  desipos_first_metabolite_idx_vmet)
LDepleted_desineg_vmet <- random_forest_comparison_LDepleted_RelativeAbundance(desi_neg_vmet, desineg_first_metabolite_idx_vmet)

# save the model performance to .txt files
capture.output(print(LDepleted_desipos_vmet2), file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET2_DESI_POS_RF_Model_RelativeAbundance.txt')
capture.output(print(LDepleted_desipos_vmet), file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET_DESI_POS_RF_Model_RelativeAbundance.txt')
capture.output(print(LDepleted_desineg_vmet2), file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET2_DESI_NEG_RF_Model_RelativeAbundance.txt')
capture.output(print(LDepleted_desineg_vmet), file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET_DESI_NEG_RF_Model_RelativeAbundance.txt')

# ROC_Information
desipos_roc_vmet2 <- get_roc(LDepleted_desipos_vmet2, c('LDominant', 'LDepleted'), 'LDepleted')
desineg_roc_vmet2 <- get_roc(LDepleted_desineg_vmet2, c('LDominant', 'LDepleted'), 'LDepleted')

desipos_roc_vmet <- get_roc(LDepleted_desipos_vmet, c('LDominant', 'LDepleted'), 'LDepleted')
desineg_roc_vmet <- get_roc(LDepleted_desineg_vmet, c('LDominant', 'LDepleted'), 'LDepleted')

# Stack the roc curves on a dataframe for plotting
pos_roc_data_vmet2 <- cbind(desipos_roc_vmet2$data, Mode=rep('Positive', dim(desipos_roc_vmet2$data)[1]), Study=rep('VMET2', dim(desipos_roc_vmet2$data)[1]))
neg_roc_data_vmet2 <- cbind(desineg_roc_vmet2$data, Mode=rep('Negative', dim(desineg_roc_vmet2$data)[1]), Study=rep('VMET2', dim(desineg_roc_vmet2$data)[1]))

pos_roc_data_vmet <- cbind(desipos_roc_vmet$data, Mode=rep('Positive', dim(desipos_roc_vmet$data)[1]), Study=rep('VMET', dim(desipos_roc_vmet$data)[1]))
neg_roc_data_vmet <- cbind(desineg_roc_vmet$data, Mode=rep('Negative', dim(desineg_roc_vmet$data)[1]), Study=rep('VMET', dim(desineg_roc_vmet$data)[1]))

desi_roc_data <- rbind(pos_roc_data_vmet2, neg_roc_data_vmet2, pos_roc_data_vmet, neg_roc_data_vmet)

rm(pos_roc_data_vmet2)
rm(neg_roc_data_vmet2)
rm(pos_roc_data_vmet)
rm(neg_roc_data_vmet)

desi_roc_data$Class <- factor(desi_roc_data$Class, levels = c('LDominant', 'LDepleted'))
desi_roc_data$Class <- as.numeric(desi_roc_data$Class) - 1

#roc_lab <- paste(paste("Negative mode: Mean AUC =", round(desineg_roc$roc$auc, 2)), '\n', paste("Positive mode: Mean AUC =", round(desipos_roc$roc$auc, 2)), sep='')

roc_Ldepleted_desi <- ggplot(desi_roc_data, 
    aes(m = target, d = Class, color=Study, linetype=Mode)) + 
    geom_roc(hjust = 0, vjust = 0, labels=F) + coord_equal() + style_roc(theme=theme_grey, xlab='1 - Specificity', ylab='Sensitivity') + ggtitle('Detection of Lactobacillus Depleted State by DESI-MS') + scale_linetype_manual(values=c("dotted", "solid"))#+ annotate("label", x = c(.75), y = c(.25), parse=FALSE, label = roc_lab)

ggsave(filename='./Lactobacillus_Depleted_Detection_DESI-MS/DESI-MS_LactobacillusDepleted_RelativeAbundance_ROC.png', roc_Ldepleted_desi)
```

## Supplementary analysis - Comparison of the out-of-bag (OOB) and Cross-validation performance estimates.
The aim of this section is to verify the agreement between classification performance metrics estimated from the Out-of-bag predictions and the repeated 7-fold cross-validation. OOB predictions have the practical advantage that a single prediction per sample is generated, without a need to aggregate the results from multiple cross-validation rounds. Since the classification metric values obtained from the OOB predictions are very similar to their corresponding cross-validated estimates, its reasonable to use the OOB predictions in other analysis. This is theoretically expected, as OOB prediction error should be similar to a leave-one-out prediction error estimates, and this analysis is included here more as an extra sanity/validation check.
```{r}
# Confusion matrix metrics calculated from the out-of-bag prediction metrics for the LDepleted detection models
vmet2_desi_neg_cvMat_LDom <- confusionMatrix(data = LDepleted_desineg_vmet2$pred$pred, reference=LDepleted_desineg_vmet2$pred$obs, mode='everything', positive = 'LDominant')
vmet2_desi_neg_cvMat_LDep <- confusionMatrix(data = LDepleted_desineg_vmet2$pred$pred, reference=LDepleted_desineg_vmet2$pred$obs, mode='everything', positive = 'LDepleted')

capture.output(print(vmet2_desi_neg_cvMat_LDom), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET2_DESI_NEG_RF_Model_CV_LDom.txt')
capture.output(print(vmet2_desi_neg_cvMat_LDep), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET2_DESI_NEG_RF_Model_CV_LDep.txt')

vmet_desi_neg_cvMat_LDom <- confusionMatrix(data = LDepleted_desineg_vmet$pred$pred, reference=LDepleted_desineg_vmet$pred$obs, mode='everything', positive = 'LDominant')
vmet_desi_neg_cvMat_LDep <- confusionMatrix(data = LDepleted_desineg_vmet$pred$pred, reference=LDepleted_desineg_vmet$pred$obs, mode='everything', positive = 'LDepleted')

capture.output(print(vmet_desi_neg_cvMat_LDom), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET_DESI_NEG_RF_Model_CV_LDom.txt')
capture.output(print(vmet_desi_neg_cvMat_LDep), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET_DESI_NEG_RF_Model_CV_LDep.txt')

vmet2_desi_pos_cvMat_LDom <- confusionMatrix(data = LDepleted_desipos_vmet2$pred$pred, reference=LDepleted_desipos_vmet2$pred$obs, mode='everything', positive= 'LDominant')
vmet2_desi_pos_cvMat_LDep <- confusionMatrix(data = LDepleted_desipos_vmet2$pred$pred, reference=LDepleted_desipos_vmet2$pred$obs, mode='everything', positive = 'LDepleted')

capture.output(print(vmet2_desi_pos_cvMat_LDom), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET2_DESI_POS_RF_Model_CV_LDom.txt')
capture.output(print(vmet2_desi_pos_cvMat_LDep), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET2_DESI_POS_RF_Model_CV_LDep.txt')

vmet_desi_pos_cvMat_LDom <- confusionMatrix(data = LDepleted_desipos_vmet$pred$pred, reference=LDepleted_desipos_vmet$pred$obs, mode='everything', positive = 'LDominant')
vmet_desi_pos_cvMat_LDep <- confusionMatrix(data = LDepleted_desipos_vmet$pred$pred, reference=LDepleted_desipos_vmet$pred$obs, mode='everything', positive = 'LDepleted')

capture.output(print(vmet_desi_pos_cvMat_LDom), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET_DESI_POS_RF_Model_CV_LDom.txt')
capture.output(print(vmet_desi_pos_cvMat_LDep), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET_DESI_POS_RF_Model_CV_LDep.txt')

# Confusion matrix metrics calculated from the out-of-bag prediction metrics for the LDepleted detection models
vmet2_desi_neg_OOB_LDom <- confusionMatrix(data = predict(LDepleted_desineg_vmet2$finalModel), reference=factor(desi_neg_vmet2$LDominant_CST), mode='everything', positive = 'LDominant')
vmet2_desi_neg_OOB_LDep <- confusionMatrix(data = predict(LDepleted_desineg_vmet2$finalModel), reference=factor(desi_neg_vmet2$LDominant_CST), mode='everything', positive = 'LDepleted')

capture.output(print(vmet2_desi_neg_OOB_LDom), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET2_DESI_NEG_RF_Model_OOB_LDom.txt')
capture.output(print(vmet2_desi_neg_OOB_LDep), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET2_DESI_NEG_RF_Model_OOB_LDep.txt')

vmet_desi_neg_OOB_LDom <- confusionMatrix(data = predict(LDepleted_desineg_vmet$finalModel), reference=factor(desi_neg_vmet$LDominant_CST), mode='everything', positive = 'LDominant')
vmet_desi_neg_OOB_LDep <- confusionMatrix(data = predict(LDepleted_desineg_vmet$finalModel), reference=factor(desi_neg_vmet$LDominant_CST), mode='everything', positive = 'LDepleted')

capture.output(print(vmet_desi_neg_OOB_LDom), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET_DESI_NEG_RF_Model_OOB_LDom.txt')
capture.output(print(vmet_desi_neg_OOB_LDep), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET_DESI_NEG_RF_Model_OOB_LDep.txt')

vmet2_desi_pos_OOB_LDom <- confusionMatrix(data = predict(LDepleted_desipos_vmet2$finalModel), reference=factor(desi_pos_vmet2$LDominant_CST), mode='everything', positive = 'LDominant')
vmet2_desi_pos_OOB_LDep <- confusionMatrix(data = predict(LDepleted_desipos_vmet2$finalModel), reference=factor(desi_pos_vmet2$LDominant_CST), mode='everything', positive = 'LDepleted')

capture.output(print(vmet2_desi_pos_OOB_LDom), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET2_DESI_POS_RF_Model_OOB_LDom.txt')
capture.output(print(vmet2_desi_pos_OOB_LDep), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET2_DESI_POS_RF_Model_OOB_LDep.txt')

vmet_desi_pos_OOB_LDom <- confusionMatrix(data = predict(LDepleted_desipos_vmet$finalModel), reference=factor(desi_pos_vmet$LDominant_CST), mode='everything', positive = 'LDominant')
vmet_desi_pos_OOB_LDep <- confusionMatrix(data = predict(LDepleted_desipos_vmet$finalModel), reference=factor(desi_pos_vmet$LDominant_CST), mode='everything', positive = 'LDepleted')

capture.output(print(vmet_desi_pos_OOB_LDom), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET_DESI_POS_RF_Model_CV_LDom.txt')
capture.output(print(vmet_desi_pos_OOB_LDep), file='./Lactobacillus_Depleted_Detection_DESI-MS/OOB_and_CV_Metrics/VMET_DESI_POS_RF_Model_CV_LDep.txt')
```

## Supplementary analysis I - Comparison of results from models with gestational age as predictor
Using gestational age as a covariate in the random effect models improves the predictive power of the LDepleted detection random forest models?
```{r}
random_forest_comparison_LDepleted_GestationalAge <- function(dataset, first_metabo_idx) {
   
   # Extract metabolic features only and column stack with the y vector
   dataset_train <- dataset[, colnames(dataset)[first_metabo_idx:dim(dataset)[2]]]
   dataset_train <- cbind(LDepleted=dataset$LDominant_CST, GestationalAge=dataset$GestationalAge, dataset_train)
   
   # Replace NA's with 0 - not necessary...
   dataset_train <- dataset_train[complete.cases(dataset_train), ]
   
   dataset_train$LDepleted <- factor(dataset_train$LDepleted)
   # 7-Fold cross-validation repeated 15 times.
   fit_control <- trainControl(method = "repeatedcv", repeats=15, classProbs = TRUE,
                              number = 7, summaryFunction=multiClassSummary, 
                              preProcOptions = c('center', 'scale'), savePredictions=TRUE)
   
   # ntree set to a "Large" number = 1000
   # mtry set here to a fixed rule of thumb value 1/3 of number of features (rule of thumb proposed in [1])
   rf_fit <- train(LDepleted ~ ., 
                   data = dataset_train, method='rf', trControl=fit_control, ntree=1000, metric='AUC', tuneGrid=data.frame(mtry=dim(dataset_train)[2]/3))
   
  return (rf_fit)
}
```
# Suplementary analysis - Using gestational age as a covariate in the random forest models
Using gestational age as a covariate in the random effect models improves the predictive power of the LDepleted detection random forest models?
```{r}
# Fit models to VMET2
LDepleted_desipos_vmet2_GestAge <- random_forest_comparison_LDepleted_GestationalAge(desi_pos_vmet2,  desipos_first_metabolite_idx_vmet2)
LDepleted_desineg_vmet2_GestAge <- random_forest_comparison_LDepleted_GestationalAge(desi_neg_vmet2, desineg_first_metabolite_idx_vmet2)
# Fit models to VMET
LDepleted_desipos_vmet_GestAge <- random_forest_comparison_LDepleted_GestationalAge(desi_pos_vmet,  desipos_first_metabolite_idx_vmet)
LDepleted_desineg_vmet_GestAge <- random_forest_comparison_LDepleted_GestationalAge(desi_neg_vmet, desineg_first_metabolite_idx_vmet)

# save the model performance metrics to .txt files
capture.output(print(LDepleted_desipos_vmet2_GestAge), file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET2_DESI_POS_RF_Model_CST_GestationalAge.txt')
capture.output(print(LDepleted_desipos_vmet_GestAge), file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET_DESI_POS_RF_Model_CST_GestationalAge.txt')
capture.output(print(LDepleted_desineg_vmet2_GestAge), file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET2_DESI_NEG_RF_Model_CST_GestationalAge.txt')
capture.output(print(LDepleted_desineg_vmet_GestAge), file='./Lactobacillus_Depleted_Detection_DESI-MS/VMET_DESI_NEG_RF_Model_CST_GestationalAge.txt')

# ROC_Information
desipos_roc_vmet2 <- get_roc(LDepleted_desipos_vmet2_GestAge, c('LDominant', 'LDepleted'), 'LDepleted')
desineg_roc_vmet2 <- get_roc(LDepleted_desineg_vmet2_GestAge, c('LDominant', 'LDepleted'), 'LDepleted')

desipos_roc_vmet <- get_roc(LDepleted_desipos_vmet_GestAge, c('LDominant', 'LDepleted'), 'LDepleted')
desineg_roc_vmet <- get_roc(LDepleted_desineg_vmet_GestAge, c('LDominant', 'LDepleted'), 'LDepleted')

# Stack the roc curves on a dataframe for plotting
pos_roc_data_vmet2 <- cbind(desipos_roc_vmet2$data, Mode=rep('Positive', dim(desipos_roc_vmet2$data)[1]), Study=rep('VMET2', dim(desipos_roc_vmet2$data)[1]))
neg_roc_data_vmet2 <- cbind(desineg_roc_vmet2$data, Mode=rep('Negative', dim(desineg_roc_vmet2$data)[1]), Study=rep('VMET2', dim(desineg_roc_vmet2$data)[1]))

pos_roc_data_vmet <- cbind(desipos_roc_vmet$data, Mode=rep('Positive', dim(desipos_roc_vmet$data)[1]), Study=rep('VMET', dim(desipos_roc_vmet$data)[1]))
neg_roc_data_vmet <- cbind(desineg_roc_vmet$data, Mode=rep('Negative', dim(desineg_roc_vmet$data)[1]), Study=rep('VMET', dim(desineg_roc_vmet$data)[1]))

desi_roc_data <- rbind(pos_roc_data_vmet2, neg_roc_data_vmet2, pos_roc_data_vmet, neg_roc_data_vmet)

# Remove intermediate variables
rm(pos_roc_data_vmet2)
rm(neg_roc_data_vmet2)
rm(pos_roc_data_vmet)
rm(neg_roc_data_vmet)

desi_roc_data$Class <- factor(desi_roc_data$Class, levels = c('LDominant', 'LDepleted'))
desi_roc_data$Class <- as.numeric(desi_roc_data$Class) - 1
# Generate the ROC curve
roc_Ldepleted_desi <- ggplot(desi_roc_data, 
    aes(m = target, d = Class, color=Study, linetype=Mode)) + 
    geom_roc(hjust = 0, vjust = 0, labels=F) + coord_equal() + style_roc(theme=theme_grey, xlab='1 - Specificity', ylab='Sensitivity') + ggtitle('Detection of Lactobacillus Depleted State by DESI-MS') + scale_linetype_manual(values=c("dotted", "solid"))#+ annotate("label", x = c(.75), y = c(.25), parse=FALSE, label = roc_lab)

# Save the ROC curve
ggsave(filename='./Lactobacillus_Depleted_Detection_DESI-MS/DESI-MS_LactobacillusDepleted_CST_ROC_GestationalAge.png', roc_Ldepleted_desi)
```
Boxplots with pairwise comparisons of resampled measures from models without and with gestational age
```{r}
vmet_pos_resamp <- resamples(list(`w/ GA`=LDepleted_desipos_vmet, `withGA`=LDepleted_desipos_vmet_GestAge))
plot_resamp_vmet_pos <- bwplot(vmet_pos_resamp)
vmet2_pos_resamp <- resamples(list(`w/ GA`=LDepleted_desipos_vmet2, `withGA`=LDepleted_desipos_vmet2_GestAge))
plot_resamp_vmet2_pos <- bwplot(vmet2_pos_resamp)

vmet_neg_resamp <- resamples(list(`w/ GA`=LDepleted_desineg_vmet, `withGA`=LDepleted_desineg_vmet_GestAge))
plot_resamp_vmet_neg <- bwplot(vmet_neg_resamp)
vmet2_neg_resamp <- resamples(list(`w/ GA`=LDepleted_desineg_vmet2, `withGA`=LDepleted_desineg_vmet2_GestAge))
plot_resamp_vmet2_neg <- bwplot(vmet2_neg_resamp)

trellis.device(device="png", filename="./Lactobacillus_Depleted_Detection_DESI-MS/RF_GAModels_VMET_pos.png")
print(plot_resamp_vmet_pos)
dev.off()
trellis.device(device="png", filename="./Lactobacillus_Depleted_Detection_DESI-MS/RF_GAModels_VMET2_pos.png")
print(plot_resamp_vmet2_pos)
dev.off()
trellis.device(device="png", filename="./Lactobacillus_Depleted_Detection_DESI-MS/RF_GAModels_VMET_neg.png")
print(plot_resamp_vmet_neg)
dev.off()
trellis.device(device="png", filename="./Lactobacillus_Depleted_Detection_DESI-MS/RF_GAModels_VMET2_neg.png")
print(plot_resamp_vmet2_neg)
dev.off()
```

## Supplementary analysis II - Comparison of results with leave subject-out CV
To in
```{r}
random_forest_comparison_LDepleted_LeaveGroupOut <- function(dataset, first_metabo_idx) {
   
   # Extract metabolic features only and column stack with the y vector
   dataset_train <- dataset[, colnames(dataset)[first_metabo_idx:dim(dataset)[2]]]
   dataset_train <- cbind(LDepleted=dataset$LDominant_CST, GestationalAge=dataset$GestationalAge, SubjectID=dataset$SubjectID, dataset_train)
   
   # Replace NA's with 0 - not necessary...
   dataset_train <- dataset_train[complete.cases(dataset_train), ]
   
   dataset_train$LDepleted <- factor(dataset_train$LDepleted)
   # 7-Fold cross-validation repeated 15 times.
   fit_control <- trainControl(index=groupKFold(dataset_train$SubjectID, 7), classProbs = TRUE,
                              summaryFunction=multiClassSummary, 
                              preProcOptions = c('center', 'scale'), savePredictions=TRUE)
   
   # ntree set to a "Large" number = 1000
   # mtry set here to a fixed rule of thumb value 1/3 of number of features (rule of thumb proposed in [1])
   rf_fit <- train(LDepleted ~ . - SubjectID, 
                   data = dataset_train, method='rf', trControl=fit_control, ntree=1000, metric='AUC', tuneGrid=data.frame(mtry=dim(dataset_train)[2]/3))
   
  return (rf_fit)
}

# Stratified 7-fold CV without repeats to allow comparison with caret resamples functions
random_forest_comparison_LDepleted_CVComp <- function(dataset, first_metabo_idx) {
   
   # Extract metabolic features only and column stack with the y vector
   dataset_train <- dataset[, colnames(dataset)[first_metabo_idx:dim(dataset)[2]]]
   dataset_train <- cbind(LDepleted=dataset$LDominant_CST, dataset_train)
   
   # Replace NA's with 0 - not necessary...
   # dataset_train[is.na(dataset_train)] <- 0
   
   dataset_train$LDepleted <- factor(dataset_train$LDepleted)
   # 7-Fold cross-validation repeated 15 times.
   fit_control <- trainControl(method = "cv", classProbs = TRUE,
                              number = 7, summaryFunction=multiClassSummary, 
                              preProcOptions = c('center', 'scale'), savePredictions=TRUE)
   
   # ntree set to a "Large" number = 1000
   # mtry set here to a fixed rule of thumb value 1/3 of number of features (rule of thumb proposed in [1])
   rf_fit <- train(LDepleted ~ ., 
                   data = dataset_train, method='rf', trControl=fit_control, ntree=1000, metric='AUC', tuneGrid=data.frame(mtry=dim(dataset_train)[2]/3))
   
  return (rf_fit)
}

```

```{r}
# Fit models to VMET2
LDepleted_desipos_vmet2_LGOCV <- random_forest_comparison_LDepleted_LeaveGroupOut(desi_pos_vmet2,  desipos_first_metabolite_idx_vmet2)
LDepleted_desipos_vmet2_7fold <- random_forest_comparison_LDepleted_CVComp(desi_pos_vmet2,  desipos_first_metabolite_idx_vmet2)

LDepleted_desineg_vmet2_LGOCV <- random_forest_comparison_LDepleted_LeaveGroupOut(desi_neg_vmet2, desineg_first_metabolite_idx_vmet2)
LDepleted_desineg_vmet2_7fold <-  random_forest_comparison_LDepleted_CVComp(desi_neg_vmet2, desineg_first_metabolite_idx_vmet2)

# Fit models to VMET
LDepleted_desipos_vmet_LGOCV <- random_forest_comparison_LDepleted_LeaveGroupOut(desi_pos_vmet,  desipos_first_metabolite_idx_vmet)
LDepleted_desipos_vmet_7fold <- random_forest_comparison_LDepleted_CVComp(desi_pos_vmet,  desipos_first_metabolite_idx_vmet)

# 
LDepleted_desineg_vmet_LGOCV <- random_forest_comparison_LDepleted_LeaveGroupOut(desi_neg_vmet, desineg_first_metabolite_idx_vmet)
LDepleted_desineg_vmet_7fold <- random_forest_comparison_LDepleted_CVComp(desi_neg_vmet, desineg_first_metabolite_idx_vmet)

vmet_pos_resamp <- resamples(list(`Standard CV`=LDepleted_desipos_vmet_7fold, `LeaveSubjectOut`=LDepleted_desipos_vmet_LGOCV))
plot_resamp_vmet_pos <- bwplot(vmet_pos_resamp)

vmet_neg_resamp <- resamples(list(`Standard CV`=LDepleted_desineg_vmet_7fold, `LeaveSubjectOut`=LDepleted_desineg_vmet_LGOCV))
plot_resamp_vmet_neg <- bwplot(vmet_neg_resamp)

vmet2_pos_resamp <- resamples(list(`Standard CV`=LDepleted_desipos_vmet2_7fold, `LeaveSubjectOut`=LDepleted_desipos_vmet2_LGOCV))
plot_resamp_vmet2_pos <- bwplot(vmet2_pos_resamp)

vmet2_neg_resamp <- resamples(list(`Standard CV`=LDepleted_desineg_vmet2_7fold, `LeaveSubjectOut`=LDepleted_desineg_vmet2_LGOCV))
plot_resamp_vmet2_neg <- bwplot(vmet2_neg_resamp)

trellis.device(device="png", filename="./Lactobacillus_Depleted_Detection_DESI-MS/RF_LGCV_Models_VMET_pos.png")
print(plot_resamp_vmet_pos)
dev.off()
trellis.device(device="png", filename="./Lactobacillus_Depleted_Detection_DESI-MS/RF_LGCV_Models_VMET2_pos.png")
print(plot_resamp_vmet2_pos)
dev.off()
trellis.device(device="png", filename="./Lactobacillus_Depleted_Detection_DESI-MS/RF_LGCV_Models_VMET_neg.png")
print(plot_resamp_vmet_neg)
dev.off()
trellis.device(device="png", filename="./Lactobacillus_Depleted_Detection_DESI-MS/RF_LGCV_Models_VMET2_neg.png")
print(plot_resamp_vmet2_neg)
dev.off()
```